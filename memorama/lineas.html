<!DOCTYPE html>
<html lang="es">
<head>
	<title>TESTING LINES</title>
	<style type="text/css">
		#canvas_fondo{
			border: 1px solid blue;
		}
	</style>
</head>
<body>
	<div id="container"></div>
	<script type="text/javascript" src="js/lib/cv.js"></script>
	<script type="text/javascript" src="js/lib/jsaruco.js"></script>
	<script type="text/javascript" src="js/lib/three.min.js"></script>
	<script type="text/javascript">

		var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
		var scene = new THREE.Scene();
		
		// CAMERA
		var WIDTH_MOVIE=600;
		var HEIGHT_MOVIE=512;
		var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
		camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);

		camera.position.set(0,0,500);
		camera.useTarget = false
		camera.position.z=800;	
		renderer = new THREE.WebGLRenderer();
		renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
		container = document.getElementById( 'container' );
		container.appendChild( renderer.domElement );
		

		function getPosicionReal(x,y,z){
			console.log("estoy sacando uno real "+(x-(500/2))+" "+(y-(500/2)));
			return new THREE.Vector3(x-(500/2),
				((-1*y)+(500/2)),z)
		}

		

		canvas_square=document.createElement("canvas");
		canvas_square.width=20;
		canvas_square.height=20;
		ctx=canvas_square.getContext("2d");
		ctx.fillStyle="#ff0000";
		ctx.fillRect(0,0,20,20);

		texture_canvas=new THREE.Texture(canvas_square);
		material_texture=new THREE.MeshBasicMaterial({map:texture_canvas,side:THREE.DoubleSide});
		material_texture.transparent=true;
		geometry_texture=new THREE.PlaneGeometry(20,20);
		screen_texture=new THREE.Mesh(geometry_texture,material_texture);
		texture_canvas.needsUpdate=true;	
		screen_texture.position=getPosicionReal(37,52,0);
		scene.add(screen_texture);

		canvas_imagen=document.createElement("canvas");
		canvas_imagen.id="canvas_fondo";
		canvas_imagen.width=500;
		canvas_imagen.height=500;
		ctx_imagen=canvas_imagen.getContext("2d");
		ctx_imagen.strokeRect(0, 0, canvas_imagen.width, canvas_imagen.height);
		textura_canvas=new THREE.Texture(canvas_imagen);  
		material_textura_fondo=new THREE.MeshBasicMaterial({map:textura_canvas,side:THREE.DoubleSide});		
		material_textura_fondo.needsUpdate=true;
		geometria_fondo=new THREE.PlaneGeometry(500,500);
		screen_fondo=new THREE.Mesh(geometria_fondo,material_textura_fondo);
		scene.add(screen_fondo);
		var detector = new AR.Detector();
		cargarImagen();
		function cargarImagen(){
		  base_image = new Image();		  
		  base_image.src = '../assets/img/imagen.jpg';
		  base_image.onload = function(){
		    ctx_imagen.drawImage(base_image, 0, 0);
		    scene.add(camera);
		    //init()
		    //insertarCanvas();    
			detectarMarcadores();
		    animate();
		  }
		}
		function addLines(geometria){
			var material = new THREE.LineBasicMaterial({
				color: 0x0000ff
			});
			

			var line = new THREE.Line( geometria, material );
			scene.add(camera);
			scene.add( line );
		}
		function animate(){			
			textura_canvas.needsUpdate=true;
			renderer.render(scene,camera);
			requestAnimationFrame(animate);
		}

		function detectarMarcadores(){						
		   	var markers = detector.detect(ctx_imagen.getImageData(0, 0, canvas_imagen.width, canvas_imagen.height));   	
		   	//puntos=[];		   	
			var geometry = new THREE.Geometry();	
		   	if(markers.length>0){
		   		for(var i=0;i<markers.length;i++)
		   			geometry.vertices.push(getPosicionReal(markers[i].corners[0].x,markers[i].corners[0].y,15));			   		
		   		addLines(geometry);
		   	}	   		
		}
	</script>
</body>
</html>